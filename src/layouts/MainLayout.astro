---
// src/layouts/MainLayout.astro

import Header from "../components/Header.astro";

import Footer from "../components/Footer.astro";

import AdminControls from "../components/AdminControls.astro"; // Import here

import "../styles/global.css";

import "../styles/theme.css";

const {
  title,

  description = "Supm3n - Build lean tools, fast visuals, and little internet contraptions.",
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <style is:inline>
      /*reset the body margins immediately, before it even attempts to load external files*/

      html,
      body {
        margin: 0;

        padding: 0;

        overflow-x: hidden; /* Prevents width jump from scrollbar appearing late */

        background-color: #0b0c10; /* Match your theme bg to prevent white flash */
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
    </style>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="description" content={description} />

    <title>{title}</title>

    <link rel="icon" href="/icons/favicon.ico" sizes="any" />

    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />

    <script>
      import { initThemeIcon } from "../scripts/theme.js";

      initThemeIcon();
    </script>
  </head>

  <body>
    <canvas id="bg-canvas"></canvas>

    <Header />

    <slot />

    <AdminControls />
    <!-- Usage here -->

    <Footer />

    <script>
      import { toggleTheme, initThemeIcon } from "../scripts/theme.js";

      initThemeIcon();

      const themeBtn = document.getElementById("theme-toggle");

      if (themeBtn) themeBtn.addEventListener("click", toggleTheme);
    </script>

    <script>
      const canvas = document.getElementById("bg-canvas");

      const ctx = canvas.getContext("2d");

      let width, height;

      let particles = [];

      const PARTICLE_COUNT = 80;

      const CONNECTION_DISTANCE = 150;

      const MOUSE_DISTANCE = 200;

      let mouse = { x: null, y: null };

      function getThemeColor(varName) {
        return getComputedStyle(document.documentElement)
          .getPropertyValue(varName)

          .trim();
      }

      function resize() {
        width = window.innerWidth;

        height = window.innerHeight;

        canvas.width = width;

        canvas.height = height;

        initParticles();
      }

      class Particle {
        constructor() {
          this.x = Math.random() * width;

          this.y = Math.random() * height;

          this.vx = (Math.random() - 0.5) * 0.3;

          this.vy = (Math.random() - 0.5) * 0.3;

          this.size = Math.random() * 2 + 1;

          this.baseSize = this.size;
        }

        update() {
          this.x += this.vx;

          this.y += this.vy;

          if (this.x < 0 || this.x > width) this.vx *= -1;

          if (this.y < 0 || this.y > height) this.vy *= -1;

          if (mouse.x != null) {
            let dx = mouse.x - this.x;

            let dy = mouse.y - this.y;

            let distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < MOUSE_DISTANCE) {
              if (this.size < this.baseSize * 2.5) this.size += 0.1;
            } else {
              if (this.size > this.baseSize) this.size -= 0.1;
            }
          } else if (this.size > this.baseSize) {
            this.size -= 0.1;
          }
        }

        draw() {
          ctx.fillStyle = getThemeColor("--particle-color");

          ctx.beginPath();

          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);

          ctx.fill();
        }
      }

      function initParticles() {
        particles = [];

        const count = width < 768 ? 40 : PARTICLE_COUNT;

        for (let i = 0; i < count; i++) particles.push(new Particle());
      }

      function animate() {
        ctx.clearRect(0, 0, width, height);

        particles.forEach((p) => {
          p.update();

          p.draw();
        });

        connectParticles();

        requestAnimationFrame(animate);
      }

      function connectParticles() {
        const lineColor = getThemeColor("--line-color");

        // Basic parse to handle opacity injection

        const baseColor = lineColor.replace(/[\d.]+\)$/g, "");
        for (let a = 0; a < particles.length; a++) {
          for (let b = a; b < particles.length; b++) {
            let dx = particles[a].x - particles[b].x;
            let dy = particles[a].y - particles[b].y;
            let distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < CONNECTION_DISTANCE) {
              let opacity = 1 - distance / CONNECTION_DISTANCE;
              ctx.strokeStyle = baseColor + opacity * 0.5 + ")";
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(particles[a].x, particles[a].y);
              ctx.lineTo(particles[b].x, particles[b].y);
              ctx.stroke();
            }
          }

          if (mouse.x != null) {
            let dx = particles[a].x - mouse.x;

            let dy = particles[a].y - mouse.y;

            let distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < MOUSE_DISTANCE) {
              let opacity = 1 - distance / MOUSE_DISTANCE;
              ctx.strokeStyle = baseColor + opacity * 0.8 + ")";
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(particles[a].x, particles[a].y);
              ctx.lineTo(mouse.x, mouse.y);
              ctx.stroke();
            }
          }
        }
      }

      window.addEventListener("resize", resize);

      window.addEventListener("mousemove", (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      });

      window.addEventListener("mouseout", () => {
        mouse.x = null;
        mouse.y = null;
      });

      resize();
      animate();
    </script>

    <style is:global>
      #bg-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: var(--bg-gradient);
        transition: background 0.3s ease;
      }
    </style>
  </body>
</html>
