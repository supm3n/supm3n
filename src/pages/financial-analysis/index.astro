---
import MainLayout from "../../layouts/MainLayout.astro";
import "../../styles/financials.css";

const COMPANIES = [
    { ticker: "NVDA", name: "NVIDIA" },
    { ticker: "AAPL", name: "Apple" },
    { ticker: "MSFT", name: "Microsoft" },
    { ticker: "GOOGL", name: "Alphabet" },
    { ticker: "AMZN", name: "Amazon" },
    { ticker: "META", name: "Meta" },
    { ticker: "TSLA", name: "Tesla" },
    { ticker: "AVGO", name: "Broadcom" },
    { ticker: "BRK.B", name: "Berkshire" },
];
---

<MainLayout title="Financial Analysis | Supm3n">
    <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="container analysis-container">
        <!-- 1. Header & Company Chips -->
        <section class="hero compact-hero">
            <h1 class="hero-title">Financial Intelligence</h1>
            <div class="company-grid">
                {
                    COMPANIES.map((c) => (
                        <button
                            class="company-chip-compact"
                            data-ticker={c.ticker}
                            aria-label={`Select ${c.name}`}
                        >
                            <span class="chip-ticker">{c.ticker}</span>
                        </button>
                    ))
                }
            </div>
        </section>

        <!-- 2. Executive Summary -->
        <section id="summary-panel" class="summary-section hidden">
            <div class="summary-header-tight">
                <div class="summary-identity">
                    <h2 id="sum-ticker" class="sum-ticker-sm">--</h2>
                    <span id="sum-period" class="sum-period-sm">--</span>
                </div>
                <div class="summary-date-sm">
                    <span>Filed: </span><span id="sum-filed">--</span>
                </div>
            </div>

            <div class="stats-grid-tight">
                <!-- Revenue -->
                <div class="stat-card-tight">
                    <div class="stat-header-row">
                        <span>Total Revenue</span>
                        <span id="delta-rev" class="stat-badge">--</span>
                    </div>
                    <div id="val-rev" class="stat-value-sm">--</div>
                </div>

                <!-- Net Income -->
                <div class="stat-card-tight">
                    <div class="stat-header-row">
                        <span>Net Income</span>
                        <span id="delta-net" class="stat-badge">--</span>
                    </div>
                    <div id="val-net" class="stat-value-sm">--</div>
                </div>

                <!-- Free Cash Flow -->
                <div class="stat-card-tight">
                    <div class="stat-header-row">
                        <span>Free Cash Flow</span>
                        <span id="delta-fcf" class="stat-badge">--</span>
                    </div>
                    <div id="val-fcf" class="stat-value-sm">--</div>
                </div>
            </div>
        </section>

        <!-- 3. Charts Dashboard -->
        <section id="dashboard" class="dashboard-wrapper hidden">
            <!-- View Tabs -->
            <div class="chart-controls">
                <div class="tab-group">
                    <button class="tab-btn active" data-view="growth"
                        >Growth</button
                    >
                    <button class="tab-btn" data-view="margins">Margins</button>
                    <button class="tab-btn" data-view="cashflow"
                        >Cash Flow</button
                    >
                </div>
            </div>

            <div class="charts-grid">
                <!-- Main Chart (Left/Top) -->
                <div class="chart-card main-chart">
                    <div class="chart-header">
                        <h3 class="chart-title" id="title-main">Overview</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-main"></canvas>
                    </div>
                </div>

                <!-- Secondary Chart (Right/Bottom) -->
                <div class="chart-card sub-chart">
                    <div class="chart-header">
                        <h3 class="chart-title" id="title-sub1">Analysis</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-sub1"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading / States -->
        <div id="loading-overlay" class="hidden">
            <div class="spinner"></div>
        </div>

        <div id="error-banner" class="error-banner hidden"></div>

        <div id="empty-state">
            <p>Select a company above to view the latest SEC financial data.</p>
        </div>
    </div>
</MainLayout>

<script>
    import {
        renderGrowthView,
        renderMarginsView,
        renderCashFlowView,
        destroyCharts,
    } from "../../scripts/financial-charts.js";

    let currentData = [];
    let currentView = "growth";

    // DOM
    const summaryPanel = document.getElementById("summary-panel");
    const dashboard = document.getElementById("dashboard");
    const emptyState = document.getElementById("empty-state");
    const loader = document.getElementById("loading-overlay");
    const errorBanner = document.getElementById("error-banner");
    const chipButtons = document.querySelectorAll(".company-chip-compact");
    const viewBtns = document.querySelectorAll(".tab-btn");
    const containers = { main: "chart-main", sub1: "chart-sub1" };

    async function loadData(ticker) {
        if (!ticker) return;

        try {
            // Loading State
            loader.classList.remove("hidden");
            errorBanner.classList.add("hidden");
            dashboard.classList.add("hidden");
            summaryPanel.classList.add("hidden");
            emptyState.classList.add("hidden");

            chipButtons.forEach((btn) => {
                btn.classList.toggle("active", btn.dataset.ticker === ticker);
            });

            const res = await fetch(`/api/financials/${ticker}`);
            if (!res.ok) throw new Error(`Failed to load ${ticker}`);

            const json = await res.json();

            // Filter ghost data
            const validData = json.filter(
                (item) => item.revenue !== null && item.revenue > 0,
            );

            if (validData.length < 2) {
                throw new Error("Insufficient valid historical data.");
            }

            currentData = validData;

            // Render
            renderExecutiveSummary(currentData);
            updateCharts();

            // Success State
            loader.classList.add("hidden");
            summaryPanel.classList.remove("hidden");
            dashboard.classList.remove("hidden");
        } catch (err) {
            loader.classList.add("hidden");
            errorBanner.textContent = err.message;
            errorBanner.classList.remove("hidden");
        }
    }

    function formatCompact(val) {
        if (!val) return "--";
        return `$${(val / 1_000_000_000).toFixed(1)}B`;
    }

    function calculateChange(curr, prev) {
        if (!prev) return null;
        return ((curr - prev) / Math.abs(prev)) * 100;
    }

    function renderExecutiveSummary(data) {
        const latest = data[data.length - 1];
        const previous = data[data.length - 2];

        document.getElementById("sum-ticker").textContent =
            `${latest.company_name}`;
        document.getElementById("sum-period").textContent =
            `${latest.fp} ${latest.fy}`;

        const dateObj = new Date(latest.filed_at);
        document.getElementById("sum-filed").textContent = isNaN(
            dateObj.getTime(),
        )
            ? latest.filed_at
            : dateObj.toLocaleDateString();

        const updateStat = (id, curr, prev) => {
            document.getElementById(`val-${id}`).textContent =
                formatCompact(curr);
            const deltaEl = document.getElementById(`delta-${id}`);
            const pct = calculateChange(curr, prev);

            if (pct === null) {
                deltaEl.textContent = "-";
                deltaEl.className = "stat-badge";
            } else {
                const isUp = pct >= 0;
                deltaEl.textContent = `${isUp ? "▲" : "▼"} ${Math.abs(pct).toFixed(1)}%`;
                deltaEl.className = `stat-badge ${isUp ? "pos" : "neg"}`;
            }
        };

        updateStat("rev", latest.revenue, previous.revenue);
        updateStat("net", latest.net_income, previous.net_income);
        updateStat("fcf", latest.free_cash_flow, previous.free_cash_flow);
    }

    function updateCharts() {
        if (!currentData.length) return;
        destroyCharts();

        const titles = {
            growth: ["Revenue vs Net Income", "Diluted EPS"],
            margins: ["Margin Trends", "Operating vs Net Margin"],
            cashflow: ["Cash Flow Breakdown", "FCF vs CapEx"],
        };

        document.getElementById("title-main").textContent =
            titles[currentView][0];
        document.getElementById("title-sub1").textContent =
            titles[currentView][1];

        if (currentView === "growth") renderGrowthView(currentData, containers);
        else if (currentView === "margins")
            renderMarginsView(currentData, containers);
        else if (currentView === "cashflow")
            renderCashFlowView(currentData, containers);
    }

    chipButtons.forEach((btn) =>
        btn.addEventListener("click", () => loadData(btn.dataset.ticker)),
    );

    viewBtns.forEach((btn) =>
        btn.addEventListener("click", (e) => {
            // Safe casting for event target
            const target = e.currentTarget;
            viewBtns.forEach((b) => b.classList.remove("active"));
            target.classList.add("active");
            currentView = target.dataset.view;
            updateCharts();
        }),
    );
</script>
