---
// src/pages/settleup/index.astro
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Settle Up (Ephemeral)">
    
    <!-- 1. THE HTML CONTENT -->
    <main class="app-main">
      <div class="app-header">
        <div class="header-brand">
          <h1 class="app-title">Settle Up (Ephemeral)</h1>
        </div>
        <p class="header-note">No data is saved.</p>
      </div>

      <section id="people-section" class="panel" aria-labelledby="people-title">
        <div class="panel-header">
          <h2 id="people-title">People</h2>
          <button type="button" id="add-person-btn" class="primary">
            Add Guest
          </button>
        </div>
        <ul id="people-list" class="people-list" aria-live="polite"></ul>
      </section>

      <section id="expenses-section" class="panel" aria-labelledby="expense-title">
        <h2 id="expense-title">Expense Form</h2>
        <form id="expense-form" novalidate>
          <div class="form-grid-2">
            <div class="form-row">
              <label for="expense-payer">Paid by</label>
              <select id="expense-payer" required></select>
            </div>
            <div class="form-row">
              <label for="expense-amount">Amount</label>
              <input
                id="expense-amount"
                name="amount"
                inputmode="decimal"
                pattern="^[0-9]+([.,][0-9]{1,2})?$"
                placeholder="0,00"
                required
                autocomplete="off"
                aria-describedby="expense-feedback"
                enterkeyhint="done"
              />
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary" id="submit-expense-btn">
              Add Expense
            </button>
            <button type="button" id="cancel-edit-btn" class="secondary" hidden>
              Cancel
            </button>
          </div>
          <p id="expense-feedback" class="form-feedback" aria-live="polite"></p>
        </form>

        <div class="table-wrapper" aria-live="polite">
          <table id="expenses-table">
            <caption>Expenses</caption>
            <thead>
              <tr>
                <th scope="col">Payer</th>
                <th scope="col">Amount</th>
                <th scope="col" class="actions">Actions</th>
              </tr>
            </thead>
            <tbody id="expenses-tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="balances-section" class="panel" aria-labelledby="balances-title">
        <h2 id="balances-title">Balances</h2>
        <ul id="balances-list" class="balances-list" aria-live="polite"></ul>
      </section>

      <section id="settlement-section" class="panel settlement-section" aria-labelledby="settlement-title">
        <h2 id="settlement-title">Settlement</h2>
        <div class="settlement-bar">
          <div class="total-summary">
            <span>Total recorded</span>
            <strong id="total-amount">â‚¬0,00</strong>
          </div>
          <button type="button" id="compute-btn" class="primary large">
            Compute Transfers
          </button>
        </div>
        <div id="settlement-results" class="settlement-results" aria-live="polite" role="status">
          Tap Compute to see who should pay whom.
        </div>
      </section>
    </main>

    <!-- 2. THE CSS -->
    <!-- Open your old 'styles.css' file, copy ALL text, and paste it between these style tags -->
    <style is:global>
        /* PASTE CONTENT OF styles.css HERE */
        :root {
            color-scheme: light dark;
            /* theme-base.css defines --bg, --fg, --surface, --muted, --link, --border */
            /* Use those directly, and only define SettleUp-specific variables here */
            --panel-bg: var(--surface);
            --text: var(--fg);
            --accent: var(--color-accent-start, #7C3AED);
            --accent-gradient: linear-gradient(135deg, var(--color-accent-start, #7C3AED), var(--color-accent-end, #06B6D4));
            --accent-text: #FFFFFF;
            --positive: #10B981;
            --negative: #EF4444;
            --focus-ring: rgba(124, 58, 237, 0.3);
            --shadow-panel: 0 4px 16px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            --shadow-sticky: 0 12px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.08) inset;
            --shadow-hover: 0 12px 40px rgba(124, 58, 237, 0.35), 0 4px 16px rgba(0, 0, 0, 0.4);
            --panel-border: var(--border);
            --surface-soft: var(--surface-2, rgba(255, 255, 255, 0.06));
            --surface-strong: var(--surface-3, rgba(255, 255, 255, 0.1));
            --field-bg: var(--surface-soft);
            --field-bg-active: var(--surface-strong);
            font-family: var(--font-sans, "Inter", "Segoe UI", system-ui, -apple-system, sans-serif);
            }

            /* Light mode overrides */
            [data-theme="light"] {
            --accent-text: #FFFFFF;
            --positive: #059669;
            --negative: #DC2626;
            --focus-ring: rgba(124, 58, 237, 0.2);
            --shadow-panel: 0 4px 16px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
            --shadow-sticky: 0 12px 32px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.08) inset;
            --shadow-hover: 0 12px 40px rgba(124, 58, 237, 0.25), 0 4px 16px rgba(0, 0, 0, 0.12);
            --panel-border: var(--border);
            --surface-soft: var(--surface-2, rgba(0, 0, 0, 0.02));
            --surface-strong: var(--surface-3, rgba(0, 0, 0, 0.04));
            --field-bg: var(--surface-soft);
            --field-bg-active: var(--surface-strong);
            }

            /* System preference light mode */
            @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                --accent-text: #FFFFFF;
                --positive: #059669;
                --negative: #DC2626;
                --focus-ring: rgba(124, 58, 237, 0.2);
                --shadow-panel: 0 4px 16px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
                --shadow-sticky: 0 12px 32px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.08) inset;
                --shadow-hover: 0 12px 40px rgba(124, 58, 237, 0.25), 0 4px 16px rgba(0, 0, 0, 0.12);
                --panel-border: var(--border);
                --surface-soft: var(--surface-2, rgba(0, 0, 0, 0.02));
                --surface-strong: var(--surface-3, rgba(0, 0, 0, 0.04));
                --field-bg: var(--surface-soft);
                --field-bg-active: var(--surface-strong);
            }
            }

            *,
            *::before,
            *::after {
            box-sizing: border-box;
            }

            body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            position: relative;
            }

            /* Background gradient matching landing page */
            body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -10%, rgba(124, 58, 237, 0.15), transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6, 182, 212, 0.1), transparent 60%),
                radial-gradient(ellipse 50% 35% at 20% 80%, rgba(239, 68, 68, 0.08), transparent 60%);
            pointer-events: none;
            z-index: -1;
            will-change: transform;
            animation: gradientShift 20s ease-in-out infinite;
            }

            [data-theme="light"] body::before {
            background: 
                radial-gradient(ellipse 80% 50% at 50% -10%, rgba(124, 58, 237, 0.08), transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6, 182, 212, 0.06), transparent 60%);
            }

            @keyframes gradientShift {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
            }

            img {
            display: block;
            }

            button,
            input,
            select {
            font: inherit;
            }

            .app-header {
            padding: 2rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: linear-gradient(180deg, var(--bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            position: relative;
            align-items: center;
            grid-column: 1 / -1;
            }

            .app-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 400px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--color-accent-start, #7C3AED), var(--color-accent-end, #06B6D4), transparent);
            opacity: 0.5;
            }

            .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            }

            .app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            padding: 8px;
            background: var(--surface-soft);
            border: 1px solid var(--border);
            }

            .app-title {
            margin: 0;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--fg) 0%, var(--color-accent-start, #7C3AED) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            }

            .header-note {
            margin: 0;
            font-size: 0.9rem;
            color: var(--muted);
            opacity: 0.9;
            }

            .app-main {
            flex: 1;
            display: grid;
            max-width: 1100px;
            margin-inline: auto;
            gap: 1rem;
            padding: 0 1rem 4rem;
            }

            #people-section {
            margin-top: 0.5rem;
            }

            #expenses-section {
            margin-top: 0.5rem;
            }

            #balances-section {
            margin-top: 0.5rem;
            }

            #settlement-section {
            margin-top: 0.5rem;
            }

            @media (min-width: 960px) {
            .app-main {
                gap: 1.25rem;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                grid-auto-rows: min-content;
                padding-bottom: 3rem;
            }

            /*compute transfer section to the bottom of the page
            #settlement-section {
                grid-column: 1 / -1;
            }*/
            }

            .panel {
            background: var(--panel-bg, var(--surface));
            border: 1px solid var(--panel-border, var(--border));
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: var(--shadow-panel);
            color: var(--text);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            }

            .panel:hover::before {
            opacity: 0.8;
            }

            .panel:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
            }

            .panel h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            color: var(--fg);
            }

            .panel-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
            }

            button {
            cursor: pointer;
            min-height: 2.75rem;
            border-radius: 12px;
            border: 1px solid transparent;
            padding: 0.65rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            }

            button.primary {
            background: var(--accent-gradient);
            color: var(--accent-text);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
            }

            button.primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
            }

            button.primary:hover::before {
            left: 100%;
            }

            button.primary:hover,
            button.primary:focus-visible {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.4), 0 0 20px rgba(124, 58, 237, 0.2);
            }

            button.secondary {
            background: var(--field-bg, transparent);
            border-color: var(--panel-border, var(--border));
            color: var(--fg);
            }

            button.secondary:hover,
            button.secondary:focus-visible {
            background: var(--field-bg-active, var(--panel-bg));
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
            }

            button.large {
            min-height: 3.5rem;
            font-size: 1.05rem;
            padding: 0.85rem 2rem;
            font-weight: 700;
            }

            button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            }

            button:not(:disabled):active {
            transform: scale(0.98);
            }

            input,
            select {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--field-bg, transparent);
            padding: 0.65rem 1rem;
            min-height: 2.75rem;
            color: var(--fg);
            font-size: 0.95rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            input::placeholder {
            color: var(--muted);
            opacity: 0.6;
            }

            input:hover,
            select:hover {
            border-color: var(--accent);
            background: var(--field-bg-active);
            }

            input:focus-visible,
            select:focus-visible,
            button:focus-visible {
            outline: none;
            border-color: var(--accent);
            background: var(--field-bg-active);
            box-shadow: 0 0 0 3px var(--focus-ring);
            }

            label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--fg);
            letter-spacing: -0.01em;
            }

            .form-row {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            }

            .form-row + .form-row {
            margin-top: 0.9rem;
            }

            .form-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            }

            .form-grid-2 {
            display: grid;
            gap: 1rem;
            }

            .form-grid-2 + .form-row {
            margin-top: 0.9rem;
            }

            .form-grid-2 .form-row + .form-row {
            margin-top: 0;
            }

            @media (min-width: 800px) {
            .form-grid-2 {
                grid-template-columns: 1fr 1fr;
                align-items: end;
            }
            }

            .form-feedback {
            min-height: 1.4rem;
            color: var(--negative);
            font-size: 0.9rem;
            margin: 0;
            }

            .optional {
            color: var(--muted);
            font-size: 0.85rem;
            }

            .people-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            }

            .person-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--panel-border, var(--border));
            border-radius: 14px;
            padding: 0.2rem 0.6rem;
            justify-content: space-between;
            background: var(--field-bg, transparent);
            transition: all 0.2s ease;
            }

            .person-row:hover {
            background: var(--field-bg-active);
            border-color: var(--accent);
            }

            .person-row input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 0.4rem;
            font-weight: 600;
            font-size: 1rem;
            color: var(--fg);
            }

            .person-row input:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 6px;
            box-shadow: none;
            }

            .person-row .secondary {
            min-height: 2.5rem;
            padding: 0.6rem 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            }

            .table-wrapper .secondary {
            min-height: 2rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            }

            .person-meta {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: 500;
            }

            .person-actions {
            display: flex;
            gap: 0.6rem;
            }

            .table-wrapper {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--panel-border, var(--border));
            background: var(--field-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) inset;
            -webkit-overflow-scrolling: touch;
            }

            /* Hide scrollbars on mobile while maintaining scroll functionality */
            @media (max-width: 600px) {
            .table-wrapper {
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE and Edge */
            }
            
            .table-wrapper::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
            }

            table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
            }

            caption {
            text-align: left;
            padding: 1rem 1.25rem;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--fg);
            border-bottom: 1px solid var(--border);
            letter-spacing: -0.01em;
            }

            thead th {
            text-align: left;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.85rem 1.25rem;
            border-bottom: 2px solid var(--border);
            color: var(--muted);
            }

            tbody td {
            padding: 0.5rem 1.25rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 1rem;
            color: var(--fg);
            }

            tbody tr {
            transition: background 0.2s ease;
            }

            tbody tr:hover {
            background: var(--surface-soft);
            }

            tbody tr:last-child td {
            border-bottom: none;
            }

            td.actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            }

            .expenses-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--muted);
            background: var(--field-bg, transparent);
            border-radius: 12px;
            font-size: 0.95rem;
            }

            .balances-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            }

            .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            border: 1px solid var(--panel-border, var(--border));
            border-radius: 14px;
            padding: 0.2rem 0.75rem;
            background: var(--field-bg, transparent);
            transition: all 0.2s ease;
            }

            .balance-item:hover {
            background: var(--field-bg-active);
            border-color: var(--accent);
            transform: translateX(4px);
            }

            .balance-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--fg);
            }

            .balance-meta {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            text-align: right;
            }

            .balance-meta span {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: 500;
            }

            .balance-amount {
            font-weight: 700;
            font-size: 1.1rem;
            }

            .balance-positive .balance-amount {
            color: var(--positive);
            }

            .balance-negative .balance-amount {
            color: var(--negative);
            }

            .settlement-section {
            position: relative;
            }

            .settlement-bar {
            position: sticky;
            bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.25rem;
            padding: 1.25rem 1.5rem;
            border-radius: 20px;
            background: var(--panel-bg, var(--surface));
            border: 1px solid var(--panel-border, var(--border));
            box-shadow: var(--shadow-sticky);
            z-index: 10;
            backdrop-filter: blur(12px);
            }

            @media (min-width: 840px) {
            .settlement-bar {
                position: static;
                box-shadow: var(--shadow-panel);
            }
            }

            .total-summary {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 600;
            }

            .total-summary strong {
            color: var(--fg);
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            }

            .settlement-results {
            border: 1px solid var(--panel-border, var(--border));
            border-radius: 16px;
            padding: 1.5rem 1.75rem;
            min-height: 4rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: var(--field-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) inset;
            }

            .settlement-results p {
            margin: 0;
            }

            .transfer-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            padding: 0.85rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            }

            .transfer-line:hover {
            background: var(--surface-soft);
            border-color: var(--accent);
            transform: translateX(4px);
            }

            .transfer-names {
            font-weight: 700;
            font-size: 1rem;
            color: var(--fg);
            }

            .transfer-amount {
            color: var(--positive);
            font-weight: 700;
            font-size: 1.1rem;
            }

            .settlement-empty {
            color: var(--muted);
            text-align: center;
            padding: 1rem;
            font-size: 0.95rem;
            }

            .app-footer {
            padding: 2rem 1rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--muted);
            display: flex;
            justify-content: center;
            margin-top: 3rem;
            border-top: 1px solid var(--border);
            background: linear-gradient(to top, var(--bg), transparent);
            }

            .app-footer p {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin: 0;
            justify-content: center;
            flex-wrap: wrap;
            font-weight: 500;
            }

            .app-footer a {
            font-weight: 600;
            transition: all 0.2s ease;
            }

            .app-footer a:hover {
            color: var(--accent);
            transform: translateY(-1px);
            }

            .footer-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.4));
            }

            @media (min-width: 600px) {
            .panel {
                padding: 1.2rem;
            }

            .app-main {
                padding-inline: 1.5rem;
                gap: 0.5rem;
            }
            
            .app-header {
                padding: 2.5rem 2rem 2rem;
            }
            }

            @media (max-width: 600px) {
            .panel {
                padding: 1.25rem;
                border-radius: 16px;
            }
            
            .panel:hover {
                transform: none;
            }
            
            .app-header {
                padding: 1.5rem 1rem 1rem;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
            
            .settlement-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                bottom: 0.5rem;
            }
            
            .total-summary {
                text-align: center;
            }
            
            .transfer-line {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            /*tbody td {
                padding: 0.75rem 0.85rem;
                font-size: 0.9rem;
            }*/
            
            thead th {
                padding: 0.75rem 0.85rem;
                font-size: 0.75rem;
            }
            
            caption {
                padding: 0.85rem 1rem;
            }
            
            button.large {
                width: 100%;
            }
            }
    </style>

    <!-- 3. THE JAVASCRIPT -->
    <!-- Open your old 'app.js' file, copy ALL text, and paste it between these script tags -->
    <script>
        const appState = {
        people: [],
        expenses: [],
        editingExpenseId: null,
        nextGuestNumber: 1,
        lastTransfers: null,
        };

        const currencyFormatter = new Intl.NumberFormat("it-IT", {
        style: "currency",
        currency: "EUR",
        });

        const addPersonBtn = document.getElementById("add-person-btn");
        const peopleListEl = document.getElementById("people-list");
        const expenseForm = document.getElementById("expense-form");
        const payerSelect = document.getElementById("expense-payer");
        const amountInput = document.getElementById("expense-amount");
        const expenseFeedbackEl = document.getElementById("expense-feedback");
        const cancelEditBtn = document.getElementById("cancel-edit-btn");
        const expensesTbody = document.getElementById("expenses-tbody");
        const balancesListEl = document.getElementById("balances-list");
        const computeBtn = document.getElementById("compute-btn");
        const settlementResultsEl = document.getElementById("settlement-results");
        const totalAmountEl = document.getElementById("total-amount");

        init();

        function init() {
        addPersonBtn.addEventListener("click", handleAddPerson);
        expenseForm.addEventListener("submit", handleExpenseSubmit);
        cancelEditBtn.addEventListener("click", exitExpenseEditMode);
        computeBtn.addEventListener("click", handleComputeSettlement);

        ensureMinimumPeople(2);
        renderAll();
        updateComputeButtonState();

        window.runTests = runTests;
        }

        function updateComputeButtonState() {
        const hasExpenses = appState.expenses.length > 0;
        const enoughPeople = appState.people.length >= 2;
        computeBtn.disabled = !(hasExpenses && enoughPeople);
        }

        function ensureMinimumPeople(count) {
        while (appState.people.length < count) {
            addPerson({ skipRender: true });
        }
        }

        function addPerson({ name, skipRender = false } = {}) {
        const personName = name ?? `Guest ${appState.nextGuestNumber++}`;
        const person = {
            id: crypto.randomUUID(),
            name: personName,
            createdAt: new Date().toISOString(),
        };
        appState.people.push(person);
        if (!skipRender) {
            afterPeopleChanged();
            focusOnPerson(person.id);
        }
        return person;
        }

        function handleAddPerson() {
        addPerson();
        }

        function focusOnPerson(personId) {
        requestAnimationFrame(() => {
            const input = peopleListEl.querySelector(
            `[data-person-id="${personId}"] input.person-name`
            );
            if (input) {
            input.focus();
            input.select();
            }
        });
        }

        function handleRenamePerson(personId, newName) {
        const trimmed = newName.trim();
        if (!trimmed) {
            return renderPeople(); // revert to previous value
        }
        const person = appState.people.find((p) => p.id === personId);
        if (person) {
            person.name = trimmed;
            renderPeople();
            renderExpenses();
            renderBalances();
            resetSettlementResults();
            updateComputeButtonState();
        }
        }

        function handleDeletePerson(personId) {
        if (isPersonReferenced(personId)) {
            return;
        }
        const person = appState.people.find((p) => p.id === personId);
        if (!person) return;
        appState.people = appState.people.filter((p) => p.id !== personId);
        if (appState.people.length === 0) {
            ensureMinimumPeople(1);
        }
        afterPeopleChanged();
        if (
            appState.editingExpenseId &&
            !appState.people.find((p) => p.id === payerSelect.value)
        ) {
            exitExpenseEditMode();
        }
        }

        function isPersonReferenced(personId) {
        return appState.expenses.some((expense) => expense.payerId === personId);
        }

        function handleExpenseSubmit(event) {
        event.preventDefault();
        clearExpenseFeedback();

        if (!appState.people.length) {
            setExpenseFeedback("Add at least one guest before recording expenses.");
            return;
        }

        const payerId = payerSelect.value;
        const amountRaw = amountInput.value;

        const amountCents = parseAmountToCents(amountRaw);
        if (amountCents === null || amountCents <= 0) {
            setExpenseFeedback("Enter a valid amount greater than zero.");
            return;
        }

        if (!appState.people.some((p) => p.id === payerId)) {
            setExpenseFeedback("Select a valid payer.");
            return;
        }

        if (appState.editingExpenseId) {
            updateExpense(appState.editingExpenseId, {
            payerId,
            amountCents,
            });
        } else {
            addExpense({
            payerId,
            amountCents,
            });
        }

        resetExpenseForm({ keepPayer: true });
        afterExpensesChanged();
        }

        function addExpense({ payerId, amountCents }) {
        const expense = {
            id: crypto.randomUUID(),
            payerId,
            amountCents,
            createdAt: new Date().toISOString(), // internal for sorting only
        };
        appState.expenses.push(expense);
        }

        function updateExpense(expenseId, updates) {
        const expense = appState.expenses.find((item) => item.id === expenseId);
        if (!expense) return;
        expense.payerId = updates.payerId;
        expense.amountCents = updates.amountCents;
        exitExpenseEditMode();
        }

        function enterExpenseEditMode(expense) {
        appState.editingExpenseId = expense.id;
        payerSelect.value = expense.payerId;
        amountInput.value = formatAmountInput(expense.amountCents);
        expenseForm.querySelector("#submit-expense-btn").textContent =
            "Update Expense";
        cancelEditBtn.hidden = false;
        expenseForm.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        function exitExpenseEditMode() {
        appState.editingExpenseId = null;
        resetExpenseForm({ keepPayer: true });
        expenseForm.querySelector("#submit-expense-btn").textContent = "Add Expense";
        cancelEditBtn.hidden = true;
        }

        function resetExpenseForm({ keepPayer } = {}) {
        const currentPayer = payerSelect.value;
        expenseForm.reset();
        if (keepPayer && currentPayer) {
            payerSelect.value = currentPayer;
        } else if (appState.people[0]) {
            payerSelect.value = appState.people[0].id;
        }
        }

        function setExpenseFeedback(message) {
        expenseFeedbackEl.textContent = message;
        }

        function clearExpenseFeedback() {
        expenseFeedbackEl.textContent = "";
        }

        function removeExpense(expenseId) {
        appState.expenses = appState.expenses.filter((expense) => expense.id !== expenseId);
        if (appState.editingExpenseId === expenseId) {
            exitExpenseEditMode();
        }
        }

        function handleComputeSettlement() {
        const financials = computeFinancialSnapshot();
        const hasBalance = financials.balances.some(
            (item) => item.balanceCents !== 0
        );

        if (!financials.totalCents || !hasBalance) {
            renderSettlementResults([], financials, { computed: true });
            appState.lastTransfers = null;
            updateComputeButtonState();
            return;
        }

        const transfers = settleBalances(financials);
        appState.lastTransfers = transfers;
        renderSettlementResults(transfers, financials, { computed: true });
        updateComputeButtonState();
        }

        function computeFinancialSnapshot(
        people = appState.people,
        expenses = appState.expenses
        ) {
        const activePeople = [...people];
        const orderedPeople = activePeople
            .slice()
            .sort(compareByCreatedAtAndId);
        const orderLookup = new Map(
            orderedPeople.map((person, index) => [person.id, index])
        );

        const totalCents = expenses.reduce(
            (sum, expense) => sum + expense.amountCents,
            0
        );

        const paidMap = new Map(
            activePeople.map((person) => [person.id, 0])
        );
        for (const expense of expenses) {
            if (paidMap.has(expense.payerId)) {
            paidMap.set(
                expense.payerId,
                paidMap.get(expense.payerId) + expense.amountCents
            );
            }
        }

        const owedMap = computeOwedMap(totalCents, orderedPeople);

        const balances = activePeople.map((person) => {
            const paidCents = paidMap.get(person.id) ?? 0;
            const owedCents = owedMap.get(person.id) ?? 0;
            return {
            ...person,
            paidCents,
            owedCents,
            balanceCents: paidCents - owedCents,
            orderIndex: orderLookup.get(person.id) ?? 0,
            };
        });

        return {
            balances,
            totalCents,
            orderedPeople,
            orderLookup,
        };
        }

        function computeOwedMap(totalCents, orderedPeople) {
        const owed = new Map();
        if (!orderedPeople.length) {
            return owed;
        }

        const share = Math.floor(totalCents / orderedPeople.length);
        let remainder = totalCents - share * orderedPeople.length;
        for (const person of orderedPeople) {
            const extra = remainder > 0 ? 1 : 0;
            owed.set(person.id, share + extra);
            if (remainder > 0) remainder -= 1;
        }
        return owed;
        }

        function settleBalances(financials) {
        const { balances, orderLookup } = financials;
        const creditors = balances
            .filter((item) => item.balanceCents > 0)
            .map((item) => ({
            id: item.id,
            amountCents: item.balanceCents,
            }));
        const debtors = balances
            .filter((item) => item.balanceCents < 0)
            .map((item) => ({
            id: item.id,
            amountCents: Math.abs(item.balanceCents),
            }));

        const tieBreaker = (aId, bId) => {
            const diff =
            (orderLookup.get(aId) ?? 0) - (orderLookup.get(bId) ?? 0);
            if (diff !== 0) return diff;
            return aId.localeCompare(bId);
        };

        const sortByMagnitude = (a, b) =>
            b.amountCents - a.amountCents || tieBreaker(a.id, b.id);

        creditors.sort(sortByMagnitude);
        debtors.sort(sortByMagnitude);

        const transfers = [];
        let guard = 0;
        while (creditors.length && debtors.length && guard < 1000) {
            creditors.sort(sortByMagnitude);
            debtors.sort(sortByMagnitude);
            const creditor = creditors[0];
            const debtor = debtors[0];
            const transferAmount = Math.min(
            creditor.amountCents,
            debtor.amountCents
            );
            transfers.push({
            fromId: debtor.id,
            toId: creditor.id,
            amountCents: transferAmount,
            });
            creditor.amountCents -= transferAmount;
            debtor.amountCents -= transferAmount;
            if (creditor.amountCents === 0) {
            creditors.shift();
            }
            if (debtor.amountCents === 0) {
            debtors.shift();
            }
            guard += 1;
        }

        const positiveTotal = balances
            .filter((item) => item.balanceCents > 0)
            .reduce((sum, item) => sum + item.balanceCents, 0);
        const transferredTotal = transfers.reduce(
            (sum, transfer) => sum + transfer.amountCents,
            0
        );
        const residual = positiveTotal - transferredTotal;
        if (residual !== 0 && transfers.length) {
            const last = transfers[transfers.length - 1];
            const adjusted = last.amountCents + residual;
            if (adjusted > 0) {
            last.amountCents = adjusted;
            }
        }

        return transfers;
        }

        function parseAmountToCents(value) {
        if (typeof value !== "string") return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        const normalised = trimmed.replace(/,/g, ".").replace(/\s+/g, "");
        if (!/^\d+(\.\d{1,2})?$/.test(normalised)) return null;

        const [eurosPart, decimalPartRaw = ""] = normalised.split(".");
        if (eurosPart.length > 1 && eurosPart.startsWith("0")) {
            // allow 0, but strip leading zeros automatically
        }

        const euros = Number.parseInt(eurosPart, 10);
        if (Number.isNaN(euros)) return null;

        let decimalPart = decimalPartRaw.slice(0, 2);
        while (decimalPart.length < 2) {
            decimalPart += "0";
        }
        const cents = decimalPart ? Number.parseInt(decimalPart, 10) : 0;
        if (Number.isNaN(cents)) return null;
        return euros * 100 + cents;
        }

        function formatCurrency(cents) {
        return currencyFormatter.format(cents / 100);
        }

        function formatAmountInput(cents) {
        const euros = Math.trunc(cents / 100);
        const remainder = Math.abs(cents % 100);
        return `${euros},${String(remainder).padStart(2, "0")}`;
        }

        function compareByCreatedAtAndId(a, b) {
        if (a.createdAt < b.createdAt) return -1;
        if (a.createdAt > b.createdAt) return 1;
        return a.id.localeCompare(b.id);
        }

        function renderAll() {
        renderPeople();
        renderPayerOptions();
        renderExpenses();
        renderBalances();
        updateTotalAmount();
        resetSettlementResults();
        }

        function afterPeopleChanged() {
        renderPeople();
        renderPayerOptions();
        renderExpenses();
        renderBalances();
        updateTotalAmount();
        resetSettlementResults();
        updateComputeButtonState();
        }

        function afterExpensesChanged() {
        renderExpenses();
        renderBalances();
        updateTotalAmount();
        resetSettlementResults();
        updateComputeButtonState();
        }

        function renderPeople() {
        peopleListEl.innerHTML = "";
        if (!appState.people.length) {
            const empty = document.createElement("li");
            empty.textContent = "Add guests to get started.";
            empty.className = "person-meta";
            peopleListEl.appendChild(empty);
            return;
        }

        const fragment = document.createDocumentFragment();
        for (const person of appState.people) {
            const row = document.createElement("li");
            row.className = "person-row";
            row.dataset.personId = person.id;

            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.value = person.name;
            nameInput.className = "person-name";
            nameInput.setAttribute("aria-label", `Name for ${person.name}`);
            nameInput.addEventListener("blur", (event) =>
            handleRenamePerson(person.id, event.target.value)
            );
            nameInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                nameInput.blur();
            } else if (event.key === "Escape") {
                event.preventDefault();
                nameInput.value = person.name;
                nameInput.blur();
            }
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "secondary";
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", () => handleDeletePerson(person.id));

            const referenced = isPersonReferenced(person.id);
            if (referenced) {
            deleteBtn.disabled = true;
            deleteBtn.title = "Delete disabled: referenced by expenses.";
            } else {
            deleteBtn.title = "Remove this guest.";
            }

            row.appendChild(nameInput);
            row.appendChild(deleteBtn);
            fragment.appendChild(row);
        }
        peopleListEl.appendChild(fragment);
        }

        function renderPayerOptions() {
        payerSelect.innerHTML = "";
        for (const person of appState.people) {
            const option = document.createElement("option");
            option.value = person.id;
            option.textContent = person.name;
            payerSelect.appendChild(option);
        }
        if (appState.people.length) {
            if (
            !appState.people.some((person) => person.id === payerSelect.value)
            ) {
            payerSelect.value = appState.people[0].id;
            }
        }
        }

        function renderExpenses() {
        expensesTbody.innerHTML = "";
        if (!appState.expenses.length) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 3;
            cell.className = "expenses-empty";
            cell.textContent = "No expenses recorded yet.";
            row.appendChild(cell);
            expensesTbody.appendChild(row);
            return;
        }

        const fragment = document.createDocumentFragment();
        const sortedExpenses = [...appState.expenses].sort((a, b) => {
            if (a.createdAt === b.createdAt) return a.id.localeCompare(b.id);
            return a.createdAt > b.createdAt ? -1 : 1;
        });

        for (const expense of sortedExpenses) {
            const tr = document.createElement("tr");

            const payerCell = document.createElement("td");
            payerCell.textContent = getPersonName(expense.payerId);

            const amountCell = document.createElement("td");
            amountCell.textContent = formatCurrency(expense.amountCents);

            const actionsCell = document.createElement("td");
            actionsCell.className = "actions";

            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className = "secondary";
            editBtn.textContent = "Edit";
            editBtn.addEventListener("click", () => enterExpenseEditMode(expense));

            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "secondary";
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", () => {
            if (window.confirm("Delete this expense?")) {
                removeExpense(expense.id);
                afterExpensesChanged();
            }
            });

            actionsCell.append(editBtn, deleteBtn);

            tr.append(payerCell, amountCell, actionsCell);
            fragment.appendChild(tr);
        }
        expensesTbody.appendChild(fragment);
        }

        function renderBalances() {
        balancesListEl.innerHTML = "";
        if (!appState.people.length) {
            return;
        }
        const financials = computeFinancialSnapshot();
        for (const item of financials.balances) {
            const li = document.createElement("li");
            li.className = "balance-item";
            if (item.balanceCents > 0) {
            li.classList.add("balance-positive");
            } else if (item.balanceCents < 0) {
            li.classList.add("balance-negative");
            }

            const name = document.createElement("span");
            name.className = "balance-name";
            name.textContent = item.name;

            const meta = document.createElement("div");
            meta.className = "balance-meta";

            const paid = document.createElement("span");
            paid.textContent = `Paid ${formatCurrency(item.paidCents)}`;

            const owed = document.createElement("span");
            owed.textContent = `Owes ${formatCurrency(item.owedCents)}`;

            const balanceAmount = document.createElement("span");
            balanceAmount.className = "balance-amount";
            balanceAmount.textContent = formatCurrency(item.balanceCents);

            meta.append(paid, owed, balanceAmount);
            li.append(name, meta);
            balancesListEl.appendChild(li);
        }
        }

        function renderSettlementResults(transfers, financials, options = {}) {
        settlementResultsEl.innerHTML = "";
        if (!transfers || !transfers.length) {
            const p = document.createElement("p");
            p.className = "settlement-empty";
            const hasBalance = financials?.balances?.some(
            (item) => item.balanceCents !== 0
            );
            if (options.computed || hasBalance) {
            p.textContent = "Nothing to settle.";
            } else {
            p.textContent = "Tap Compute to see who should pay whom.";
            }
            settlementResultsEl.appendChild(p);
            return;
        }

        for (const transfer of transfers) {
            const line = document.createElement("div");
            line.className = "transfer-line";

            const names = document.createElement("span");
            names.className = "transfer-names";
            names.textContent = `${getPersonName(transfer.fromId)} â†’ ${getPersonName(
            transfer.toId
            )}`;

            const amount = document.createElement("span");
            amount.className = "transfer-amount";
            amount.textContent = formatCurrency(transfer.amountCents);

            line.append(names, amount);
            settlementResultsEl.appendChild(line);
        }
        }

        function resetSettlementResults() {
        appState.lastTransfers = null;
        settlementResultsEl.innerHTML = "";
        const p = document.createElement("p");
        p.className = "settlement-empty";
        p.textContent = "Tap Compute to see who should pay whom.";
        settlementResultsEl.appendChild(p);
        }

        function updateTotalAmount() {
        const total = appState.expenses.reduce(
            (sum, expense) => sum + expense.amountCents,
            0
        );
        totalAmountEl.textContent = formatCurrency(total);
        }

        function getPersonName(personId) {
        const person = appState.people.find((item) => item.id === personId);
        return person ? person.name : "Unknown";
        }

        function runTests() {
        const peopleTemplate = (names) =>
            names.map((name, index) => ({
            id: name,
            name,
            createdAt: new Date(2024, 0, index + 1).toISOString(),
            }));

        const scenarios = [
            {
            label: "Scenario 1",
            people: peopleTemplate(["A", "B", "C"]),
            expenses: [
                {
                id: "e1",
                payerId: "A",
                amountCents: 6000,
                },
                {
                id: "e2",
                payerId: "B",
                amountCents: 2000,
                },
            ],
            expected: [
                { fromId: "C", toId: "A", amountCents: 2666 },
                { fromId: "B", toId: "A", amountCents: 667 },
            ],
            },
            {
            label: "Scenario 2",
            people: peopleTemplate(["A", "B", "C", "D"]),
            expenses: [
                {
                id: "e1",
                payerId: "A",
                amountCents: 4000,
                },
                {
                id: "e2",
                payerId: "B",
                amountCents: 4000,
                },
                {
                id: "e3",
                payerId: "C",
                amountCents: 4000,
                },
            ],
            expected: [
                { fromId: "D", toId: "A", amountCents: 1000 },
                { fromId: "D", toId: "B", amountCents: 1000 },
                { fromId: "D", toId: "C", amountCents: 1000 },
            ],
            },
            {
            label: "Scenario 3",
            people: peopleTemplate(["A", "B", "C"]),
            expenses: [
                {
                id: "e1",
                payerId: "C",
                amountCents: 10000,
                },
            ],
            expected: [
                { fromId: "A", toId: "C", amountCents: 3334 },
                { fromId: "B", toId: "C", amountCents: 3333 },
            ],
            },
            {
            label: "Scenario 4",
            people: peopleTemplate(["A", "B", "C"]),
            expenses: [
                {
                id: "e1",
                payerId: "A",
                amountCents: 3000,
                },
                {
                id: "e2",
                payerId: "B",
                amountCents: 3000,
                },
                {
                id: "e3",
                payerId: "C",
                amountCents: 3000,
                },
            ],
            expected: [],
            },
        ];

        const results = scenarios.map((scenario) => {
            const financials = computeFinancialSnapshot(
            scenario.people,
            scenario.expenses
            );
            const transfers = financials.balances.some(
            (item) => item.balanceCents !== 0
            )
            ? settleBalances(financials)
            : [];
            const pass = compareTransfers(transfers, scenario.expected);
            logScenarioResult(scenario.label, pass, transfers, scenario.expected);
            return pass;
        });

        if (results.every(Boolean)) {
            console.log("âœ… All sanity scenarios passed.");
        } else {
            console.log("âŒ One or more sanity scenarios failed.");
        }
        }

        function compareTransfers(actual, expected) {
        if (actual.length !== expected.length) return false;
        for (let i = 0; i < actual.length; i += 1) {
            const a = actual[i];
            const e = expected[i];
            if (
            a.fromId !== e.fromId ||
            a.toId !== e.toId ||
            a.amountCents !== e.amountCents
            ) {
            return false;
            }
        }
        return true;
        }

        function logScenarioResult(label, pass, actual, expected) {
        const formatLine = (transfer) =>
            `${transfer.fromId} â†’ ${transfer.toId} ${formatCurrency(
            transfer.amountCents
            )}`;
        if (pass) {
            console.log(`âœ… ${label}`);
        } else {
            console.group(`âŒ ${label}`);
            console.log("Expected:", expected.map(formatLine));
            console.log("Actual:", actual.map(formatLine));
            console.groupEnd();
        }
        }

        // Manual checklist:
        // - Add 3 guests, run all four scenarios â†’ exact outputs.
        // - Rename a guest â†’ expenses still attribute correctly.
        // - Enter 12,34 and 12.34 both render as â‚¬12,34.
        // - Refresh â†’ everything is cleared.
        // - Mobile: sticky bar visible; compute reachable with thumb.


        console.log("SettleUp loaded");
    </script>

</MainLayout>