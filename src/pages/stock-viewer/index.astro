---
// src/pages/stock-viewer/index.astro
import MainLayout from "../../layouts/MainLayout.astro";
---

<MainLayout title="Stock Chart">
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="container stocks-page-container">
    <section class="hero">
      <h1 class="hero-title">Stock Viewer</h1>
      <p class="hero-subtitle">Real-time market data visualization</p>
    </section>

    <section class="toolbar glass-panel">
      <div class="input-group">
        <label class="input-label" for="symbol-select">Select Asset</label>
        <div class="select-wrapper">
          <select id="symbol-select" class="tech-input">
            <option value="">Choose from list...</option>
            <optgroup label="Tech & Auto">
              <option value="AAPL">Apple (AAPL)</option>
              <option value="MSFT">Microsoft (MSFT)</option>
              <option value="GOOGL">Alphabet (GOOGL)</option>
              <option value="AMZN">Amazon (AMZN)</option>
              <option value="TSLA">Tesla (TSLA)</option>
              <option value="META">Meta (META)</option>
              <option value="NVDA">NVIDIA (NVDA)</option>
              <option value="NFLX">Netflix (NFLX)</option>
            </optgroup>
            <optgroup label="Finance & Retail">
              <option value="JPM">JPMorgan (JPM)</option>
              <option value="V">Visa (V)</option>
              <option value="MA">Mastercard (MA)</option>
              <option value="WMT">Walmart (WMT)</option>
              <option value="PG">Procter & Gamble (PG)</option>
              <option value="JNJ">Johnson & Johnson (JNJ)</option>
              <option value="DIS">Disney (DIS)</option>
            </optgroup>
            <optgroup label="Crypto">
              <option value="BTC">Bitcoin (BTC)</option>
              <option value="ETH">Ethereum (ETH)</option>
              <option value="XRP">XRP (XRP)</option>
            </optgroup>
          </select>
          <div class="select-arrow">
            <svg
              width="10"
              height="6"
              viewBox="0 0 10 6"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"><path d="M1 1L5 5L9 1"></path></svg
            >
          </div>
        </div>
      </div>

      <div class="divider-wrapper">
        <div class="divider-line"></div>
        <span class="divider-text">OR</span>
        <div class="divider-line"></div>
      </div>

      <div class="input-group">
        <label class="input-label" for="symbol">Custom Symbol</label>
        <div class="input-wrapper">
          <input
            id="symbol"
            class="tech-input"
            placeholder="e.g. IBM"
            autocomplete="off"
            spellcheck="false"
          />
          <div class="input-icon">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line></svg
            >
          </div>
        </div>
      </div>

      <div class="action-group">
        <button id="load" class="btn-primary">
          <span>Load Chart</span>
          <svg
            class="btn-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"
            ></polyline><polyline points="17 6 23 6 23 12"></polyline></svg
          >
        </button>
      </div>
    </section>

    <div id="error-banner" class="error-banner" style="display: none;"></div>

    <div id="chart-wrap" class="glass-panel">
      <canvas id="chart"></canvas>

      <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Initializing Stream...</p>
      </div>

      <div id="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <p>System Ready. Select an asset to visualize data.</p>
      </div>
    </div>
  </div>
</MainLayout>

<style>
  :root {
    --stocks-accent: var(--color-accent-start);
    --stocks-accent-end: var(--color-accent-end);
  }

  .stocks-page-container {
    padding-top: var(--space-lg);
    padding-bottom: var(--space-2xl);
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Hero Section */
  .hero {
    text-align: center;
    margin-bottom: var(--space-xl);
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--glass-border);
  }

  .hero-title {
    margin: 0 0 0.5rem 0;
    /* Updated to match Settle Up size */
    font-size: clamp(2rem, 4vw, 3rem);
    line-height: 1.1;
    background: linear-gradient(
      135deg,
      var(--color-text-primary) 0%,
      var(--stocks-accent) 50%,
      var(--stocks-accent-end) 100%
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
    letter-spacing: -0.02em;
    text-transform: uppercase; /* Added to match Settle Up style */
  }

  .hero-subtitle {
    color: var(--color-text-muted);
    /* Updated to match Settle Up size */
    font-size: 0.9rem;
    font-family: var(--font-mono); /* Tech vibe */
    opacity: 0.9;
  }

  /* TOOLBAR GRID
     Using CSS Grid for precise alignment of the 4 parts:
     [Select] [OR] [Input] [Button]
  */
  .toolbar {
    display: grid;
    grid-template-columns: 2fr auto 1fr auto;
    gap: 1.5rem;
    align-items: end; /* Align to bottom so inputs align with button */
    margin-bottom: var(--space-lg);
    padding: 1.5rem;
  }

  /* Input Groups */
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .input-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    font-weight: 600;
    margin-left: 4px;
  }

  /* Tech Inputs (Shared Styles) */
  .tech-input {
    width: 100%;
    height: 48px;
    padding: 0 1rem;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: rgba(0, 0, 0, 0.2); /* Darker well */
    color: var(--color-text-primary);
    outline: none;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .tech-input::placeholder {
    color: var(--color-text-muted);
    opacity: 0.5;
  }

  .tech-input:hover {
    border-color: var(--color-text-muted);
    background: rgba(0, 0, 0, 0.3);
  }

  .tech-input:focus {
    border-color: var(--stocks-accent);
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    background: rgba(0, 0, 0, 0.4);
  }

  /* Select Specifics */
  .select-wrapper {
    position: relative;
  }
  select.tech-input {
    cursor: pointer;
    appearance: none;
    padding-right: 2.5rem;
  }
  .select-arrow {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--color-text-muted);
    display: flex;
  }

  /* Manual Input Specifics */
  .input-wrapper {
    position: relative;
  }
  .input-wrapper input {
    padding-right: 2.5rem;
  }
  .input-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
    opacity: 0.5;
  }

  /* Divider */
  .divider-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 48px; /* Match input height */
    gap: 4px;
  }
  .divider-text {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-muted);
    font-weight: 700;
    opacity: 0.5;
  }
  .divider-line {
    width: 1px;
    height: 10px;
    background: var(--glass-border);
  }

  /* Action Button */
  .action-group {
    padding-bottom: 1px; /* Tiny optical alignment adjustment */
  }

  .btn-primary {
    height: 48px;
    padding: 0 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: linear-gradient(
      135deg,
      var(--stocks-accent),
      var(--stocks-accent-end)
    );
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-family: var(--font-sans);
    font-size: 0.95rem;
    transition: all 0.2s ease;
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(124, 58, 237, 0.5);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    filter: grayscale(1);
    transform: none;
  }

  /* Chart Area */
  #chart-wrap {
    position: relative;
    height: 60vh;
    min-height: 450px;
    width: 100%;
    padding: 1px; /* Border container */
    overflow: hidden;
  }

  #chart {
    position: relative;
    z-index: 2;
    padding: 1rem;
  }

  /* Empty State */
  #empty-state {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    z-index: 1;
    pointer-events: none;
    background: radial-gradient(
      circle at center,
      rgba(124, 58, 237, 0.05) 0%,
      transparent 70%
    );
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
    filter: grayscale(1);
  }

  #empty-state p {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    opacity: 0.7;
  }

  /* Loading Spinner */
  #loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    border-radius: 16px;
    z-index: 10;
    color: var(--color-text-primary);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--stocks-accent);
    border-right-color: var(--stocks-accent-end);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  #loading-overlay p {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    animation: pulse 1.5s infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  @keyframes pulse {
    50% {
      opacity: 0.5;
    }
  }

  .hidden {
    display: none !important;
  }

  /* Error Banner */
  .error-banner {
    margin: 0 auto 1.5rem;
    padding: 1rem;
    border-left: 4px solid var(--color-red-cape);
    background: rgba(239, 68, 68, 0.1);
    color: #ff8888;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    backdrop-filter: blur(10px);
  }

  /* Mobile Responsive */
  @media (max-width: 850px) {
    .toolbar {
      grid-template-columns: 1fr; /* Stack vertically */
      gap: 1.25rem;
      padding: 1.25rem;
    }

    .divider-wrapper {
      flex-direction: row;
      height: auto;
      width: 100%;
      margin: 0.5rem 0;
    }

    .divider-line {
      width: 100%;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        var(--glass-border),
        transparent
      );
    }

    .btn-primary {
      width: 100%;
      justify-content: center;
      margin-top: 0.5rem;
    }

    #chart-wrap {
      height: 50vh;
    }
  }
</style>

<script>
  // Stock Viewer Logic
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("symbol");
    const selectEl = document.getElementById("symbol-select");
    const loadBtn = document.getElementById("load");
    const chartCanvas = document.getElementById("chart");
    const loadingOverlay = document.getElementById("loading-overlay");
    const emptyState = document.getElementById("empty-state");

    if (!chartCanvas) return;

    const ctx = chartCanvas.getContext("2d");
    let chart;
    let isLoading = false;

    function normalizeSymbol(raw) {
      let s = String(raw || "")
        .trim()
        .toUpperCase();
      if (s === "APPL") s = "AAPL"; // Common typo fix
      return s;
    }

    function getSymbol() {
      const fromInput = input && input.value ? input.value.trim() : "";
      const fromSelect = selectEl && selectEl.value ? selectEl.value : "";
      // Input takes precedence if typed
      return normalizeSymbol(fromInput || fromSelect || "");
    }

    function pickSeries(json) {
      return (
        json["Time Series (Daily)"] ||
        json["Time Series (Digital Currency Daily)"] ||
        json["Time Series (5min)"] ||
        json["Time Series (60min)"] ||
        null
      );
    }

    function toRows(series) {
      const rows = Object.entries(series).map(([date, o]) => ({
        date,
        close: Number(
          o["4. close"] || o["4a. close (USD)"] || o["5. adjusted close"] || 0,
        ),
      }));
      rows.sort((a, b) => new Date(a.date) - new Date(b.date));
      return rows;
    }

    function showError(msg) {
      const el = document.getElementById("error-banner");
      if (el) {
        el.textContent = `> ERROR: ${msg}`;
        el.style.display = "block";
      }
    }

    function clearError() {
      const el = document.getElementById("error-banner");
      if (el) {
        el.textContent = "";
        el.style.display = "none";
      }
    }

    async function fetchSymbol(symbol) {
      let r = await fetch(`/api/price/${encodeURIComponent(symbol)}`);

      if (!r.ok) {
        const text = await r.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {}
        const msg = json?.message || json?.error || `HTTP Error ${r.status}`;
        throw new Error(msg);
      }

      const json = await r.json();
      if (json.Note) throw new Error(json.Note);
      if (json["Error Message"]) throw new Error(json["Error Message"]);

      const series = pickSeries(json);
      if (!series || !Object.keys(series).length) {
        throw new Error("No data available for this symbol.");
      }

      return toRows(series);
    }

    function render(rows, symbol) {
      if (!ctx) return;
      const labels = rows.map((r) => r.date);
      const data = rows.map((r) => r.close);

      // Hide empty state
      if (emptyState) emptyState.style.display = "none";

      // @ts-ignore
      if (chart) {
        chart.destroy();
      }

      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, "rgba(124, 58, 237, 0.5)");
      gradient.addColorStop(1, "rgba(124, 58, 237, 0)");

      // @ts-ignore
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: symbol.toUpperCase(),
              data,
              fill: true,
              backgroundColor: gradient,
              borderColor: "#7c3aed",
              pointBackgroundColor: "#06b6d4",
              pointBorderColor: "#fff",
              pointHoverBackgroundColor: "#fff",
              pointHoverBorderColor: "#06b6d4",
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 6,
            },
          ],
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "rgba(15, 17, 20, 0.95)",
              titleColor: "#e2e8f0",
              titleFont: { family: "JetBrains Mono" },
              bodyColor: "#e2e8f0",
              bodyFont: { family: "JetBrains Mono" },
              borderColor: "rgba(124, 58, 237, 0.3)",
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return "PRICE: $" + Number(context.parsed.y).toFixed(2);
                },
              },
            },
          },
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 8,
                color: "#64748b",
                font: { family: "JetBrains Mono", size: 10 },
              },
              grid: { display: false },
            },
            y: {
              beginAtZero: false,
              ticks: {
                color: "#64748b",
                font: { family: "JetBrains Mono", size: 10 },
                callback: function (value) {
                  return "$" + value;
                },
              },
              grid: { color: "rgba(255,255,255,0.03)" },
            },
          },
        },
      });
    }

    async function load() {
      if (isLoading) return;

      clearError();
      const symbol = getSymbol();
      if (!symbol) {
        showError("Please select a stock or enter a symbol.");
        return;
      }

      try {
        isLoading = true;
        if (loadBtn) {
          loadBtn.disabled = true;
          loadBtn.innerHTML = `<div class="spinner" style="width:16px; height:16px; border-width:2px;"></div> <span>SYNCING...</span>`;
        }
        if (loadingOverlay) loadingOverlay.classList.remove("hidden");

        const rows = await fetchSymbol(symbol);
        render(rows, symbol);
      } catch (err) {
        showError(err.message);
      } finally {
        isLoading = false;
        if (loadBtn) {
          loadBtn.disabled = false;
          loadBtn.innerHTML = `<span>Load Chart</span>
        <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`;
        }
        if (loadingOverlay) loadingOverlay.classList.add("hidden");
      }
    }

    if (loadBtn) loadBtn.addEventListener("click", load);
    if (input)
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          load();
        }
      });

    // Update input state on dropdown change, but DO NOT fetch
    if (selectEl)
      selectEl.addEventListener("change", () => {
        if (selectEl.value) {
          input.value = ""; // Clear manual input
        }
      });
  });
</script>
