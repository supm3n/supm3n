```
---
// src/pages/stock-viewer/index.astro
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Stock Chart">
  <!-- Chart.js CDN -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="container stocks-page-container">
    <section class="hero">
      <h1 class="hero-title">Stock Viewer</h1>
      <p class="hero-subtitle">Real-time market data visualization</p>
    </section>

    <section class="toolbar glass-panel">
      <div class="input-group">
        <label class="sr-only" for="symbol-select">Select Stock</label>
        <select id="symbol-select" class="search-input">
          <option value="">Select a stock...</option>
          <option value="AAPL">Apple (AAPL)</option>
          <option value="MSFT">Microsoft (MSFT)</option>
          <option value="GOOGL">Alphabet (GOOGL)</option>
          <option value="AMZN">Amazon (AMZN)</option>
          <option value="TSLA">Tesla (TSLA)</option>
          <option value="META">Meta (META)</option>
          <option value="NVDA">NVIDIA (NVDA)</option>
          <option value="JPM">JPMorgan (JPM)</option>
          <option value="V">Visa (V)</option>
          <option value="JNJ">Johnson & Johnson (JNJ)</option>
          <option value="WMT">Walmart (WMT)</option>
          <option value="PG">Procter & Gamble (PG)</option>
          <option value="MA">Mastercard (MA)</option>
          <option value="DIS">Disney (DIS)</option>
          <option value="NFLX">Netflix (NFLX)</option>
        </select>
      </div>
      
      <div class="input-group">
        <label class="sr-only" for="symbol">Or enter custom symbol</label>
        <input 
          id="symbol" 
          class="search-input" 
          placeholder="Enter symbol (e.g. BTC)" 
          autocomplete="off"
          spellcheck="false"
        />
      </div>

      <button id="load" class="btn-primary">Load Chart</button>
    </section>

    <div id="error-banner" style="display: none;"></div>

    <div id="chart-wrap" class="glass-panel">
      <canvas id="chart"></canvas>
      <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
</MainLayout>

<style is:global>
  /* Stock Viewer CSS */
  :root {
    --stocks-accent: var(--color-accent-start);
    --stocks-accent-end: var(--color-accent-end);
  }

  .stocks-page-container {
    padding-top: 2rem; 
    padding-bottom: 4rem;
    max-width: 1400px; /* Wider container for chart */
  }

  .hero {
    text-align: center;
    margin-bottom: 2rem;
  }

  .hero-title {
    margin: 0 0 0.5rem 0;
    font-size: clamp(2rem, 5vw, 3.5rem);
    line-height: 1.1;
    background: linear-gradient(135deg, var(--color-text-primary) 0%, var(--stocks-accent) 50%, var(--stocks-accent-end) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
  }

  .hero-subtitle {
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  /* Chart Wrapper */
  #chart-wrap {
    position: relative;
    height: min(70vh, 700px);
    width: 100%;
    margin: 1.5rem auto;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  #chart { width: 100%; height: 100%; }

  /* Toolbar */
  .toolbar {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    padding: 1.5rem;
    justify-content: center;
  }

  .input-group {
    position: relative;
    flex: 1;
    min-width: 200px;
    max-width: 300px;
  }

  /* Inputs */
  .search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: var(--color-surface-1);
    color: var(--color-text-primary);
    outline: none;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  select.search-input {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a9b1c6' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }

  .search-input:focus-visible {
    border-color: var(--stocks-accent);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    background: var(--color-surface-2);
  }

  /* Button */
  .btn-primary {
    padding: 0.75rem 2rem;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, var(--stocks-accent), var(--stocks-accent-end));
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
    white-space: nowrap;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(124, 58, 237, 0.4);
  }
  
  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* Loading Spinner */
  #loading-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 16px;
    z-index: 10;
  }
  
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid rgba(255,255,255,0.1);
    border-left-color: var(--stocks-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { display: none !important; }

  /* Error Banner */
  #error-banner {
    max-width: 800px;
    margin: 0 auto 1.5rem;
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-red-cape);
    font-size: 0.9rem;
    text-align: center;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .toolbar { flex-direction: column; align-items: stretch; }
    .input-group { max-width: none; }
    .btn-primary { width: 100%; }
    #chart-wrap { height: 50vh; padding: 0.5rem; }
  }
</style>

<script>
  // Stock Viewer Logic
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('symbol');
    const selectEl = document.getElementById('symbol-select');
    const loadBtn = document.getElementById('load');
    const chartCanvas = document.getElementById('chart');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    if (!chartCanvas) return;

    const ctx = chartCanvas.getContext('2d');
    let chart;
    let isLoading = false;

    function normalizeSymbol(raw){
      let s = String(raw || '').trim().toUpperCase();
      if (s === 'APPL') s = 'AAPL';
      return s;
    }

    function getSymbol(){
      const fromInput = input && input.value ? input.value.trim() : '';
      const fromSelect = selectEl && selectEl.value ? selectEl.value : '';
      // Input takes precedence if typed
      return normalizeSymbol(fromInput || fromSelect || '');
    }

    function pickSeries(json){
      return json['Time Series (Daily)']
          || json['Time Series (Digital Currency Daily)']
          || json['Time Series (5min)']
          || json['Time Series (60min)']
          || null;
    }

    function toRows(series){
      const rows = Object.entries(series).map(([date, o]) => ({
        date,
        close: Number(o['4. close'] || o['4a. close (USD)'] || o['5. adjusted close'] || 0)
      }));
      rows.sort((a,b)=> new Date(a.date) - new Date(b.date));
      return rows;
    }

    function showError(msg){
      const el = document.getElementById('error-banner');
      if(el){
        el.textContent = msg;
        el.style.display = 'block';
      }
    }

    function clearError(){
      const el = document.getElementById('error-banner');
      if (el) {
        el.textContent = '';
        el.style.display = 'none';
      }
    }

    async function fetchSymbol(symbol){
      // Call the Cloudflare Function
      const r = await fetch(`/api/price/${encodeURIComponent(symbol)}`);
      
      if (!r.ok) {
        const text = await r.text();
        let json;
        try { json = JSON.parse(text); } catch(e) { /* ignore */ }
        const msg = json?.message || json?.error || `HTTP Error ${r.status}`;
        throw new Error(msg);
      }

      const json = await r.json();
      
      if (json.Note) throw new Error(json.Note);
      if (json['Error Message']) throw new Error(json['Error Message']);
      
      const series = pickSeries(json);
      if(!series || !Object.keys(series).length) {
        throw new Error('No data available for this symbol.');
      }
      
      return toRows(series);
    }

    function render(rows, symbol){
      if(!ctx) return;
      const labels = rows.map(r=>r.date);
      const data = rows.map(r=>r.close);
      
      // @ts-ignore
      if(chart){ chart.destroy(); }
      
      // Create gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(124, 58, 237, 0.5)');
      gradient.addColorStop(1, 'rgba(124, 58, 237, 0)');

      // @ts-ignore
      chart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels, 
          datasets: [{ 
            label: symbol.toUpperCase(), 
            data, 
            fill: true, 
            backgroundColor: gradient,
            borderColor: '#7c3aed', 
            pointBackgroundColor: '#06b6d4',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#06b6d4',
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6
          }] 
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          interaction: { mode:'index', intersect:false },
          plugins: { 
            legend: { display: false }, 
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#e2e8f0',
              bodyColor: '#e2e8f0',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: { 
            x: { 
              ticks: { maxTicksLimit: 8, color: '#64748b' }, 
              grid: { display: false } 
            }, 
            y: { 
              beginAtZero: false, 
              ticks: { 
                color: '#64748b',
                callback: function(value) { return '$' + value; }
              }, 
              grid: { color: 'rgba(255,255,255,0.03)' } 
            } 
          }
        }
      });
    }

    async function load(){
      if (isLoading) return; // Prevent multiple clicks
      
      clearError();
      const symbol = getSymbol();
      if(!symbol){ 
        showError('Please select a stock or enter a symbol.'); 
        return; 
      }

      try{
        isLoading = true;
        if (loadBtn) { loadBtn.disabled = true; loadBtn.textContent = 'Loadingâ€¦'; }
        if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        
        const rows = await fetchSymbol(symbol);
        render(rows, symbol);
      }catch(err){
        showError(`Error: ${err.message}`);
      }finally{
        isLoading = false;
        if (loadBtn) { loadBtn.disabled = false; loadBtn.textContent = 'Load Chart'; }
        if (loadingOverlay) loadingOverlay.classList.add('hidden');
      }
    }

    if (loadBtn) loadBtn.addEventListener('click', load);
    if (input) input.addEventListener('keydown', (e)=>{ 
      if(e.key==='Enter') {
        e.preventDefault();
        load(); 
      }
    });
    
    // Auto-load if symbol is selected from dropdown
    if (selectEl) selectEl.addEventListener('change', () => {
       if(selectEl.value) {
         input.value = ''; // Clear manual input
         load();
       }
    });
  });
</script>
```