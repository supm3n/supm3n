---
// src/pages/stock-viewer/index.astro
import MainLayout from "../../layouts/MainLayout.astro";
---

<MainLayout title="Stock Chart">
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="container stocks-page-container">
    <section class="hero">
      <h1 class="hero-title">Stock Viewer</h1>
      <p class="hero-subtitle">Real-time market data visualization</p>
    </section>

    <section class="toolbar glass-panel">
      <div class="input-group">
        <label class="input-label" for="symbol-select">Select Asset</label>
        <div class="select-wrapper">
          <select id="symbol-select" class="tech-input">
            <option value="">Choose from list...</option>
            <optgroup label="Tech & Auto">
              <option value="AAPL">Apple (AAPL)</option>
              <option value="MSFT">Microsoft (MSFT)</option>
              <option value="GOOGL">Alphabet (GOOGL)</option>
              <option value="AMZN">Amazon (AMZN)</option>
              <option value="TSLA">Tesla (TSLA)</option>
              <option value="NVDA">NVIDIA (NVDA)</option>
            </optgroup>
            <optgroup label="Finance">
              <option value="JPM">JPMorgan (JPM)</option>
              <option value="V">Visa (V)</option>
            </optgroup>
            <optgroup label="Crypto">
              <option value="BTC">Bitcoin (BTC)</option>
              <option value="ETH">Ethereum (ETH)</option>
              <option value="SOL">Solana (SOL)</option>
            </optgroup>
          </select>
          <div class="select-arrow">
            <svg
              width="10"
              height="6"
              viewBox="0 0 10 6"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"><path d="M1 1L5 5L9 1"></path></svg
            >
          </div>
        </div>
      </div>

      <div class="divider-wrapper">
        <div class="divider-line"></div>
        <span class="divider-text">OR</span>
        <div class="divider-line"></div>
      </div>

      <div class="input-group">
        <label class="input-label" for="symbol">Custom Symbol</label>
        <div class="input-wrapper">
          <input
            id="symbol"
            class="tech-input"
            placeholder="e.g. IBM"
            autocomplete="off"
            spellcheck="false"
          />
          <div class="input-icon">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line></svg
            >
          </div>
        </div>
      </div>

      <div class="action-group">
        <button id="load" class="btn-primary">
          <span>Load Chart</span>
          <svg
            class="btn-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"
            ></polyline><polyline points="17 6 23 6 23 12"></polyline></svg
          >
        </button>
      </div>
    </section>

    <div id="error-banner" class="error-banner" style="display: none;"></div>

    <div id="chart-wrap" class="glass-panel">
      <div class="chart-controls hidden" id="chart-controls">
        <button class="range-btn" data-range="1W">1W</button>
        <button class="range-btn" data-range="1M">1M</button>
        <button class="range-btn" data-range="3M">3M</button>
        <button class="range-btn" data-range="1Y">1Y</button>
        <button class="range-btn active" data-range="ALL">MAX</button>
      </div>

      <div class="chart-container-inner">
        <canvas id="chart"></canvas>
      </div>

      <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Initializing Stream...</p>
      </div>

      <div id="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <p>System Ready. Select an asset to visualize data.</p>
      </div>
    </div>
  </div>
</MainLayout>

<style>
  :root {
    --stocks-accent: var(--color-accent-start);
    --stocks-accent-end: var(--color-accent-end);
  }

  .stocks-page-container {
    padding-top: var(--space-lg);
    padding-bottom: var(--space-2xl);
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Hero Section */
  .hero {
    text-align: center;
    margin-bottom: var(--space-xl);
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--glass-border);
  }

  .hero-title {
    margin: 0 0 0.5rem 0;
    font-size: clamp(2rem, 4vw, 3rem);
    line-height: 1.1;
    background: linear-gradient(
      135deg,
      var(--color-text-primary) 0%,
      var(--stocks-accent) 50%,
      var(--stocks-accent-end) 100%
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
    letter-spacing: -0.02em;
    text-transform: uppercase;
  }

  .hero-subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    font-family: var(--font-mono);
    opacity: 0.9;
  }

  /* Toolbar */
  .toolbar {
    display: grid;
    grid-template-columns: 2fr auto 1fr auto;
    gap: 1.5rem;
    align-items: end;
    margin-bottom: var(--space-lg);
    padding: 1.5rem;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .input-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    font-weight: 600;
    margin-left: 4px;
  }

  .tech-input {
    width: 100%;
    height: 48px;
    padding: 0 1rem;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: rgba(0, 0, 0, 0.2);
    color: var(--color-text-primary);
    outline: none;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  .tech-input:focus {
    border-color: var(--stocks-accent);
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    background: rgba(0, 0, 0, 0.4);
  }

  /* Select/Input Wrappers */
  .select-wrapper,
  .input-wrapper {
    position: relative;
  }
  select.tech-input {
    cursor: pointer;
    appearance: none;
    padding-right: 2.5rem;
  }
  .select-arrow,
  .input-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--color-text-muted);
    display: flex;
    opacity: 0.5;
  }

  /* Divider */
  .divider-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 48px;
    gap: 4px;
  }
  .divider-text {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-muted);
    font-weight: 700;
    opacity: 0.5;
  }
  .divider-line {
    width: 1px;
    height: 10px;
    background: var(--glass-border);
  }

  /* Button */
  .action-group {
    padding-bottom: 1px;
  }
  .btn-primary {
    height: 48px;
    padding: 0 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: linear-gradient(
      135deg,
      var(--stocks-accent),
      var(--stocks-accent-end)
    );
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-family: var(--font-sans);
    font-size: 0.95rem;
    transition: all 0.2s ease;
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(124, 58, 237, 0.5);
    border-color: rgba(255, 255, 255, 0.3);
  }
  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    filter: grayscale(1);
    transform: none;
  }

  /* CHART AREA */
  #chart-wrap {
    position: relative;
    height: 65vh;
    min-height: 500px;
    width: 100%;
    padding: 1rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .chart-container-inner {
    flex: 1;
    position: relative;
    width: 100%;
    height: 100%;
  }

  /* Range Buttons */
  .chart-controls {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 1rem;
    z-index: 5;
  }

  .range-btn {
    background: transparent;
    border: 1px solid var(--glass-border);
    color: var(--color-text-muted);
    padding: 4px 12px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .range-btn:hover {
    border-color: var(--color-text-primary);
    color: var(--color-text-primary);
  }

  .range-btn.active {
    background: rgba(124, 58, 237, 0.2);
    border-color: var(--stocks-accent);
    color: #fff;
  }

  /* Empty State */
  #empty-state {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    z-index: 1;
    pointer-events: none;
    background: radial-gradient(
      circle at center,
      rgba(124, 58, 237, 0.05) 0%,
      transparent 70%
    );
  }
  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
    filter: grayscale(1);
  }

  /* Spinner */
  #loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    border-radius: 16px;
    z-index: 10;
    color: var(--color-text-primary);
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--stocks-accent);
    border-right-color: var(--stocks-accent-end);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .hidden {
    display: none !important;
  }

  /* Error Banner */
  .error-banner {
    margin: 0 auto 1.5rem;
    padding: 1rem;
    border-left: 4px solid var(--color-red-cape);
    background: rgba(239, 68, 68, 0.1);
    color: #ff8888;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    backdrop-filter: blur(10px);
  }

  @media (max-width: 850px) {
    .toolbar {
      grid-template-columns: 1fr;
      gap: 1.25rem;
      padding: 1.25rem;
    }
    .divider-wrapper {
      flex-direction: row;
      height: auto;
      width: 100%;
      margin: 0.5rem 0;
    }
    .divider-line {
      width: 100%;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        var(--glass-border),
        transparent
      );
    }
    .btn-primary {
      width: 100%;
      justify-content: center;
      margin-top: 0.5rem;
    }
    #chart-wrap {
      height: 50vh;
    }
    .chart-controls {
      justify-content: center;
    }
  }
</style>

<script>
  // --- VARIABLES (Module Scope) ---
  let isLoading = false;
  let chart;
  let currentData = [];
  let currentSymbol = "";

  // --- DOM ELEMENTS ---
  const input = document.getElementById("symbol");
  const selectEl = document.getElementById("symbol-select");
  const loadBtn = document.getElementById("load");
  const chartCanvas = document.getElementById("chart");
  const loadingOverlay = document.getElementById("loading-overlay");
  const emptyState = document.getElementById("empty-state");
  const controlsDiv = document.getElementById("chart-controls");
  const rangeBtns = document.querySelectorAll(".range-btn");
  const ctx = chartCanvas?.getContext("2d");

  // --- 1. CHART PLUGIN: CROSSHAIR (X & Y Lines) ---
  const crosshairPlugin = {
    id: "crosshair",
    afterDatasetsDraw(chart) {
      if (
        chart.tooltip &&
        chart.tooltip.getActiveElements &&
        chart.tooltip.getActiveElements().length > 0
      ) {
        const activePoint = chart.tooltip.getActiveElements()[0];
        const {
          ctx,
          chartArea: { top, bottom, left, right },
        } = chart;
        const x = activePoint.element.x;
        const y = activePoint.element.y;

        ctx.save();
        ctx.beginPath();

        // Vertical Line
        ctx.moveTo(x, top);
        ctx.lineTo(x, bottom);

        // Horizontal Line (New)
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);

        ctx.lineWidth = 1;
        ctx.strokeStyle = "rgba(255, 255, 255, 0.15)"; // Subtle tech dash
        ctx.setLineDash([4, 4]);
        ctx.stroke();
        ctx.restore();
      }
    },
  };

  // --- 2. HELPER FUNCTIONS ---
  function normalizeSymbol(raw) {
    let s = String(raw || "")
      .trim()
      .toUpperCase();
    if (s === "APPL") s = "AAPL";
    return s;
  }

  function getSymbol() {
    const fromInput = input && input.value ? input.value.trim() : "";
    const fromSelect = selectEl && selectEl.value ? selectEl.value : "";
    return normalizeSymbol(fromInput || fromSelect || "");
  }

  function showError(msg) {
    const el = document.getElementById("error-banner");
    if (el) {
      el.textContent = `> ERROR: ${msg}`;
      el.style.display = "block";
    }
  }

  function clearError() {
    const el = document.getElementById("error-banner");
    if (el) {
      el.textContent = "";
      el.style.display = "none";
    }
  }

  // --- 3. DATA FILTERING ---
  function filterDataByRange(data, range) {
    if (range === "ALL" || !data.length) return data;

    const end = new Date(data[data.length - 1].date);
    let start = new Date(end);

    switch (range) {
      case "1W":
        start.setDate(end.getDate() - 7);
        break;
      case "1M":
        start.setMonth(end.getMonth() - 1);
        break;
      case "3M":
        start.setMonth(end.getMonth() - 3);
        break;
      case "1Y":
        start.setFullYear(end.getFullYear() - 1);
        break;
    }

    return data.filter((item) => new Date(item.date) >= start);
  }

  function handleRangeChange(e) {
    if (!currentData.length) return;

    // UI Updates
    rangeBtns.forEach((btn) => btn.classList.remove("active"));
    e.target.classList.add("active");

    const range = e.target.dataset.range;
    const filtered = filterDataByRange(currentData, range);
    render(filtered, currentSymbol);
  }

  // --- 4. MAIN FETCH ---
  async function fetchSymbol(symbol) {
    let r = await fetch(`/api/price/${encodeURIComponent(symbol)}`);
    if (!r.ok) {
      let msg = `HTTP Error ${r.status}`;
      try {
        const json = await r.json();
        msg = json.error || msg;
      } catch (e) {}
      throw new Error(msg);
    }
    const rows = await r.json();
    if (!Array.isArray(rows) || rows.length === 0) {
      throw new Error("Invalid data format received.");
    }
    return rows;
  }

  // --- 5. RENDER CHART ---
  function render(rows, symbol) {
    if (!ctx) return;
    const labels = rows.map((r) => r.date);
    const data = rows.map((r) => r.close);

    if (emptyState) emptyState.style.display = "none";

    // @ts-ignore
    const existingChart = Chart.getChart(chartCanvas);
    if (existingChart) {
      existingChart.destroy();
    }

    // 1. Determine Trend Color (Green vs Red)
    const startPrice = data[0];
    const endPrice = data[data.length - 1];
    const isUp = endPrice >= startPrice;

    // Tech Green (#10B981) or Tech Red (#EF4444)
    const lineColor = isUp ? "#10B981" : "#EF4444";
    // Matching Gradient Colors
    const gradientStart = isUp
      ? "rgba(16, 185, 129, 0.5)"
      : "rgba(239, 68, 68, 0.5)";
    const gradientEnd = isUp ? "rgba(16, 185, 129, 0)" : "rgba(239, 68, 68, 0)";

    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, gradientStart);
    gradient.addColorStop(1, gradientEnd);

    // @ts-ignore
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: symbol.toUpperCase(),
            data,
            fill: true,
            backgroundColor: gradient,
            borderColor: lineColor, // Dynamic Color
            pointBackgroundColor: lineColor,
            pointBorderColor: "#fff",
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: lineColor,
            tension: 0.2,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHitRadius: 10, // Easier to hover
          },
        ],
      },
      plugins: [crosshairPlugin],
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            displayColors: false, // <--- FIX: REMOVES THE BLUE BOX
            backgroundColor: "rgba(11, 12, 16, 0.95)",
            titleColor: "#94a3b8",
            titleFont: { family: "JetBrains Mono", size: 12 },
            bodyColor: "#e2e8f0",
            bodyFont: { family: "JetBrains Mono", size: 14, weight: "bold" },
            borderColor: "rgba(255, 255, 255, 0.1)",
            borderWidth: 1,
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              title: function (context) {
                const dateStr = context[0].label;
                return new Date(dateStr).toLocaleDateString(undefined, {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                });
              },
              label: function (context) {
                // Add commas for thousands: $1,234.56
                const value = Number(context.parsed.y).toLocaleString(
                  undefined,
                  {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  },
                );
                return `$${value}`;
              },
            },
          },
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 6,
              color: "#64748b",
              font: { family: "JetBrains Mono", size: 11 },
              maxRotation: 0, // Keep dates horizontal
              autoSkip: true,
            },
            grid: { display: false },
          },
          y: {
            position: "right",
            ticks: {
              color: "#64748b",
              font: { family: "JetBrains Mono", size: 11 },
              callback: function (value) {
                // Format Y-Axis numbers too
                return "$" + Number(value).toLocaleString();
              },
            },
            grid: {
              color: "rgba(255,255,255,0.03)",
              drawBorder: false, // Cleaner look
            },
          },
        },
      },
    });
  }

  async function load() {
    if (isLoading) return;
    clearError();
    const symbol = getSymbol();
    if (!symbol) {
      showError("Please select a stock or enter a symbol.");
      return;
    }

    try {
      isLoading = true;
      if (loadBtn) {
        loadBtn.disabled = true;
        loadBtn.innerHTML = `<div class="spinner" style="width:16px; height:16px; border-width:2px;"></div> <span>SYNCING...</span>`;
      }
      if (loadingOverlay) loadingOverlay.classList.remove("hidden");

      // Fetch Data
      currentData = await fetchSymbol(symbol);
      currentSymbol = symbol;

      // Reset buttons to MAX
      if (controlsDiv) controlsDiv.classList.remove("hidden");
      rangeBtns.forEach((btn) => btn.classList.remove("active"));
      document.querySelector('[data-range="ALL"]')?.classList.add("active");

      render(currentData, symbol);
    } catch (err) {
      showError(err.message);
    } finally {
      isLoading = false;
      if (loadBtn) {
        loadBtn.disabled = false;
        loadBtn.innerHTML = `<span>Load Chart</span>
      <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`;
      }
      if (loadingOverlay) loadingOverlay.classList.add("hidden");
    }
  }

  // --- EVENT LISTENERS ---
  if (loadBtn) loadBtn.addEventListener("click", load);
  if (input)
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        load();
      }
    });
  if (selectEl)
    selectEl.addEventListener("change", () => {
      if (selectEl.value) {
        input.value = "";
      }
    });

  rangeBtns.forEach((btn) => btn.addEventListener("click", handleRangeChange));
</script>
